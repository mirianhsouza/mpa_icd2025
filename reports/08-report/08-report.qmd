---
title: "Introdu√ß√£o √† Ci√™ncia de Dados"
subtitle: "Aula 10"
lang: pt-BR
author: "M√≠rian Helena"
format: 
  html:
    theme: cosmo
    embed-resources: true
    toc: true
    number-sections: true
execute:
  message: false
  warning: false
  echo: true
---

<style>
body {
  font-size: 13pt;
  text-align: justify;
}
</style>


```{r}
#| label: setup
#| echo: false

# Cofigura√ß√µes para exibic√£o de n√∫meros
options(
  digits = 5, # n√∫mero de casas decimais
  scipen = 999 # desativa nota√ß√£o cient√≠fica
)

# carrega pacotes
library(here)
library(tidyverse)
library(triangulr)
library(highcharter)
library(tidyquant)
library(patchwork)
```



# Simula√ß√£o de Monte Carlo: Aplica√ß√µes

## An√°lise de Insolv√™ncia via Simula√ß√£o de Monte Carlo

### Fator de Insolv√™ncia de Kanitz

**Origem:** Desenvolvido por Stephen Kanitz [@kanitz1978livro] 
para empresas brasileiras.

**F√≥rmula:**

$$
FI = 0,05A + 1,65B + 3,55C ‚Äì 1,06D ‚Äì 0,33E
$$

**Indicadores:**

- $A =$ Rentabilidade do PL: lucro l√≠quido / patrim√¥nio l√≠quido
- $B =$ Liquidez Geral: (AC + RLP) / exig√≠vel total  
- $C =$ Liquidez Seca: (AC - estoques) / passivo circulante
- $D =$ Liquidez Corrente: ativo circulante / passivo circulante
- $E =$ Grau de Endividamento: passivo total / patrim√¥nio l√≠quido

**Interpreta√ß√£o:**

- $FI > 0$: **Solvente** (baixo risco)
- $-3 \leq FI \leq 0$: **"Penumbra"** (risco moderado)  
- $FI < -3$: **Insolvente** (alto risco)

**Por que simular?** Os indicadores financeiros t√™m incerteza. 
A simula√ß√£o quantifica o **risco de classifica√ß√£o incorreta**.



Simula√ß√£o em R:

```{r}
# ==================================================
# Fator de Insolv√™ncia de Kanitz - Simula√ß√£o em R
# ==================================================

# Fixa a semente para reprodutibilidade
set.seed(2024)

# N√∫mero de simula√ß√µes
n_simulacoes <- 100000

# ==================================================
# 1. C√ÅLCULO DETERMIN√çSTICO (VALOR PONTUAL)
# ==================================================

# Calcular FI usando os valores modais (determin√≠stico)
fi_deterministico <- 0.05*0.15 + 1.65*1.60 + 3.55*0.90 - 1.06*4.50 - 0.33*5.00

# ==================================================
# 2. SIMULA√á√ÉO DE MONTE CARLO
# ==================================================

# Simular os indicadores financeiros com par√¢metros dentro das fun√ß√µes rtri
A <- rtri(n_simulacoes, 0.12, 0.20, 0.15)  # Rentabilidade do PL
B <- rtri(n_simulacoes, 0.80, 2.80, 1.60)  # Liquidez Geral
C <- rtri(n_simulacoes, 0.80, 1.00, 0.90)  # Liquidez Seca
D <- rtri(n_simulacoes, 4.00, 5.30, 4.50)  # Liquidez Corrente
E <- rtri(n_simulacoes, 3.50, 8.00, 5.00)  # Grau de Endividamento

# Calcular o Fator de Insolv√™ncia para cada simula√ß√£o
FI <- 0.05*A + 1.65*B + 3.55*C - 1.06*D - 0.33*E

# ==================================================
# 3. RESULTADOS
# ==================================================

# Resultado determin√≠stico
cat("FI Determin√≠stico:", fi_deterministico, "\n")

# Resultados da simula√ß√£o
cat("FI M√©dio (simula√ß√£o):", mean(FI), "\n")
cat("Probabilidade de Solv√™ncia:", mean(FI > 0)*100, "%\n")
cat("Probabilidade de Penumbra:", mean(FI >= -3 & FI <= 0)*100, "%\n")
cat("Probabilidade de Insolv√™ncia:", mean(FI < -3)*100, "%\n")
```




## An√°lise de Viabilidade sob Incerteza 

- VPL Determin√≠stico vs. Simula√ß√£o - Cen√°rio Base

**Par√¢metros do Projeto (Valores Mais Prov√°veis):**

- **Investimento inicial**: R$ 75.000 (ponto m√©dio: 65.000 - 85.000)
- **Receitas anuais**: R$ 14.000 (ponto m√©dio: 12.000 - 16.000)  
- **Dura√ß√£o**: 10 anos (valor modal da triangular: 9 - 11 anos)
- **Taxa de desconto**: 13% a.a. (valor modal da triangular: 10% - 15%)
- **Valor residual**: R$ 5.000 (valor modal da triangular: 4.000 - 6.000)

**C√°lculo do VPL Determin√≠stico:**

```{r}
# Par√¢metros determin√≠sticos (valores modais)
investimento_det <- 75000
receita_anual_det <- 14000
duracao_det <- 10
taxa_desconto_det <- 0.13
valor_residual_det <- 5000

# C√°lculo do VPL usando a f√≥rmula padr√£o
# VPL = ‚àë[Receitas/(1+r)^t] + Valor_Residual/(1+r)^n - Investimento_Inicial

# Fluxos de receitas descontados
vpl_receitas_det <- sum(receita_anual_det / (1 + taxa_desconto_det)^(1:duracao_det))

# Valor residual descontado
vpl_residual_det <- valor_residual_det / (1 + taxa_desconto_det)^duracao_det

# VPL final
vpl_deterministico <- vpl_receitas_det + vpl_residual_det - investimento_det

# Resultados com formata√ß√£o brasileira
cat("VPL das receitas:", format(round(vpl_receitas_det, 0), big.mark = ".", decimal.mark = ","), "reais\n")
cat("VPL do valor residual:", format(round(vpl_residual_det, 0), big.mark = ".", decimal.mark = ","), "reais\n")
cat("VPL total (determin√≠stico):", format(round(vpl_deterministico, 0), big.mark = ".", decimal.mark = ","), "reais\n")

# Decis√£o baseada no VPL determin√≠stico
if (vpl_deterministico > 0) {
  cat("Decis√£o: Projeto VI√ÅVEL (VPL > 0)\n")
} else {
  cat("Decis√£o: Projeto INVI√ÅVEL (VPL ‚â§ 0)\n")
}
```

**Limita√ß√µes da An√°lise Determin√≠stica:**

- **Ignora incerteza**: Usa apenas valores pontuais, sem 
considerar variabilidade

- **Decis√£o bin√°ria**: Resultado √∫nico n√£o quantifica probabilidade de erro

- **Subestima risco**: N√£o mostra amplitude de cen√°rios poss√≠veis

-  **Informa√ß√£o limitada**: N√£o informa sobre distribui√ß√£o de resultados

**Pr√≥ximo Passo:** 

A **Simula√ß√£o de Monte Carlo** captura toda essa incerteza, 
fornecendo uma **avalia√ß√£o probabil√≠stica completa** do risco do projeto.



Simula√ß√£o de VPL - C√≥digo Comentado 

```{r}
# Configura√ß√£o inicial para reprodutibilidade
set.seed(567)
n_sim <- 100000  # 100 mil simula√ß√µes

# PASSO 1: Simula as vari√°veis/inputs do VPL
invest_rec <- runif(n_sim, 65000, 85000)    # Investimento inicial (uniforme)
residual   <- rtri(n_sim, 4000, 6000, 5000)   # Valor residual (triangular)
tempo      <- round(rtri(n_sim, 9, 11, 10))   # Dura√ß√£o em anos (triangular)
taxa       <- rtri(n_sim, 0.10, 0.15, 0.13)  # Taxa de desconto (triangular)

# PASSO 2: simula as receitas e calcula VPL
vpl_sim <- sapply(seq_len(n_sim), function(i) {
  
  # Gera receitas aleat√≥rias para o projeto i 
  receitas <- runif(tempo[i], 12000, 16000)
  
  # Calcula VPL dos fluxos de receitas descontados
  vpl_fluxos <- sum(receitas / (1 + taxa[i])^(1:tempo[i]))
  
  # VPL total = fluxos + valor residual - investimento inicial
  vpl_total <- vpl_fluxos + residual[i]/(1 + taxa[i])^tempo[i] - invest_rec[i]
  
  return(vpl_total)  # retorna VPL do projeto i
})


# VPL simulado mediano
vpl_mediano <- median(vpl_sim)  # Mediana dos VPLs simulados
vpl_mediano

# Estimativa da Probabilidade de Viabilidade
prob_viavel <- mean(vpl_sim > 0) * 100  # % de projetos com VPL > 0
prob_viavel

# Estimativa da Probabilidade de Inviabilidade
prob_inviavel <- mean(vpl_sim <= 0) * 100  # % de projetos com VPL ‚â§ 0
prob_inviavel
```

**Por que esse c√≥digo √© assim?**

- **Linha 5-9**: Cada projeto tem caracter√≠sticas **fixas**
 (dura√ß√£o, taxa, etc.)
 
- **Linha 12**: `sapply()` processa cada projeto **individualmente**

- **Linha 15**: Receitas s√£o **diferentes para cada projeto** 
(tamanho varia com `tempo[i]`)

- **Linha 18**: F√≥rmula padr√£o do VPL aplicada ao projeto `i`

**Resultado**: Vetor `vpl_sim` com 100.000 VPLs simulados prontos 
para an√°lise.





## Aplica√ß√£o: Gest√£o de Capital de Giro no Agroneg√≥cio


**Import√¢ncia Econ√¥mica:**

- Agroneg√≥cio representa **parcela significativa do PIB brasileiro**

- Soja: uma das principais commodities de exporta√ß√£o

- Produ√ß√£o com **caracter√≠sticas sazonais**: descasamento temporal 
entre custos e receitas

**Caracter√≠sticas do Ciclo Financeiro:**

- **Desembolsos concentrados**: per√≠odo de plantio (insumos, maquin√°rio)
- **Receitas concentradas**: per√≠odo de colheita e comercializa√ß√£o
- **D√©ficit de caixa tempor√°rio**: meses entre investimento e retorno

**Principais Incertezas:**

- **Produtividade**: fatores clim√°ticos, fitossanit√°rios, qualidade do solo
- **Pre√ßos**: volatilidade dos mercados internacionais de commodities
- **Custos de insumos**: fertilizantes, defensivos, combust√≠vel
- **Taxa de c√¢mbio**: impacta custos (importa√ß√µes) e receitas (exporta√ß√µes)

**Problema Gerencial:**

Qual o **capital de giro necess√°rio** para atravessar o ciclo 
produtivo sem comprometer a opera√ß√£o?

**Relev√¢ncia da Simula√ß√£o:**

- M√©todos determin√≠sticos podem **subestimar** necessidades de capital
- Monte Carlo permite capturar **intera√ß√µes entre m√∫ltiplas vari√°veis incertas**
- Possibilita **quantificar probabilidades** de diferentes cen√°rios

**Nota**: Os par√¢metros utilizados neste exemplo s√£o **ilustrativos** 
para fins did√°ticos apenas.



## Modelagem: Fluxo de Caixa da Safra de Soja


**Fazenda Hipot√©tica:**

- **√Årea**: 2.000 hectares
- **Ciclo**: Janeiro (plantio) ‚Üí Outubro (colheita/venda)
- **Custo total**: R$ 4.000/hectare

**Cronograma de Desembolsos (% do custo total - exemplo t√≠pico):**

| M√™s | Jan | Fev | Mar | Abr | Mai | Jun | Jul | Ago | Set | Out |
|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| % Custo | 10% | 25% | 20% | 10% | 5% | 5% | 5% | 5% | 5% | 10% |

**Nota**: Os 10% em outubro representam custos de colheita, transporte 
e comercializa√ß√£o.

**Receitas:**

- **Venda antecipada** (janeiro): 30% da produ√ß√£o a pre√ßo forward (desconto 5%)
- **Venda spot** (outubro): 70% da produ√ß√£o restante

**Par√¢metros Incertos (para fins did√°ticos):**

| Vari√°vel          | M√≠nimo  | Moda   | M√°ximo | Unidade   |
|-------------------|---------|--------|--------|-----------|
| **Produtividade** | 45      | 60     | 75     | sacas/ha  |
| **Pre√ßo spot**    | 70      | 85     | 100    | R\$/saca   |
| **Custo/hectare** | 3.500   | 4.000  | 4.500  | R\$/ha     |

**Correla√ß√£o Assumida:**

- Produtividade √ó Pre√ßo: -0.30 (hip√≥tese: anos de baixa produ√ß√£o 
‚Üí pre√ßos mais altos)

**Objetivo da Simula√ß√£o:**

Estimar a **distribui√ß√£o do D√©ficit M√°ximo (Necessidade de Capital de Giro)**  

$$
\text{D√©ficit m√°ximo} = -\min_t\bigl(\mathrm{SA}_t\bigr)
$$

‚ûú *Simula√ß√£o de Monte Carlo (MC)*  

&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ 20 000 cen√°rios de **produtividade, pre√ßo** 
(correla√ß√£o ‚Äì0,30) e **custo**  
&nbsp;&nbsp;&nbsp;&nbsp;‚Ä¢ Resultado: **curva de probabilidade** da 
necessidade de caixa ao longo do ciclo

**Metodologia:**

- A metodologia de simula√ß√£o segue as diretrizes de @hardaker2004 
para gest√£o de risco agr√≠cola e implementa os procedimentos de 
@richardson2000 para simula√ß√£o Monte Carlo no agroneg√≥cio.

** Importante**: Todos os par√¢metros s√£o **ilustrativos**. Em aplica√ß√µes
reais, devem ser calibrados com dados hist√≥ricos espec√≠ficos da regi√£o 
e cultura.





## Simula√ß√£o de Monte Carlo: C√≥digo R

Implementa√ß√£o da Simula√ß√£o"

```{r}
# Par√¢metros da fazenda hipot√©tica
set.seed(123)
area_ha <- 2000
n_sim <- 20000

# Cronograma de desembolsos (% do custo total por m√™s)
cronograma_custos <- c(0.10, 0.25, 0.20, 0.10, 0.05, 0.05, 0.05, 0.05, 0.05, 0.10)

# Par√¢metros de comercializa√ß√£o
venda_antecipada <- 0.30 # 30% vendido antecipadamente
desconto_forward <- 0.95 # pre√ßo forward = 95% do spot

# Fun√ß√£o para simular um cen√°rio
simula_safra <- function() {
  # Simula par√¢metros incertos (distribui√ß√µes triangulares)
  produtividade <- rtri(1, 45, 75, 60) # sacas/ha
  custo_ha <- rtri(1, 3500, 4500, 4000) # R$/ha
  
  # Gerar pre√ßo base
  preco_base <- rtri(1, 70, 100, 85) # R$/saca
  
  # Aplicar correla√ß√£o negativa de -0.30 entre produtividade e pre√ßo
  # Normalizar produtividade em torno da m√©dia
  prod_media <- 60
  prod_desvio <- 15 # (75-45)/2
  prod_padronizada <- (produtividade - prod_media) / prod_desvio
  
  # Ajustar pre√ßo baseado na correla√ß√£o
  preco_desvio <- 15 # (100-70)/2
  ajuste_correlacao <- -0.30 * prod_padronizada * preco_desvio
  preco_spot <- preco_base + ajuste_correlacao
  
  # Garantir que o pre√ßo permane√ßa dentro dos limites
  preco_spot <- pmax(70, pmin(100, preco_spot))
  
  # Calcula fluxos mensais
  custos_mensais <- cronograma_custos * custo_ha * area_ha
  
  # Receitas (concentradas em janeiro e outubro)
  receitas <- rep(0, 10)
  receitas[1] <- venda_antecipada * produtividade * area_ha * preco_spot * desconto_forward
  receitas[10] <- (1 - venda_antecipada) * produtividade * area_ha * preco_spot
  
  # Fluxo de caixa acumulado
  fluxo_liquido <- receitas - custos_mensais
  saldo_acumulado <- cumsum(fluxo_liquido)
  
  # Retorna m√©tricas de interesse
  data.frame(
    deficit_maximo = -min(saldo_acumulado), # maior d√©ficit no per√≠odo (sempre positivo)
    lucro_final = saldo_acumulado[10],      # resultado final
    produtividade = produtividade,
    preco_final = preco_spot
  )
}

# Executa simula√ß√£o Monte Carlo
resultados <- do.call(rbind, lapply(1:n_sim, function(x) simula_safra()))

# Verificar correla√ß√£o obtida
correlacao_simulada <- cor(resultados$produtividade, resultados$preco_final)
cat("Correla√ß√£o obtida:", round(correlacao_simulada, 3), "(alvo: -0.30)\n")

# Exibe resumo b√°sico como data frame
resumo_basico <- data.frame(
  M√©trica = c("D√©ficit m√°ximo m√©dio", "Maior d√©ficit simulado", "Lucro m√©dio esperado"),
  Valor_Mil_Reais = c(
    round(mean(resultados$deficit_maximo) / 1000),
    round(max(resultados$deficit_maximo) / 1000),
    round(mean(resultados$lucro_final) / 1000)
  )
)

# Exibe o resumo b√°sico
resumo_basico
```



## Resultados da Simula√ß√£o: Necessidade de Capital de Giro

An√°lise dos Resultados

```{r}
# A vari√°vel deficit_maximo j√° est√° em valores positivos (em reais)
# Converte para milh√µes para facilitar a leitura
necessidade_capital <- resultados$deficit_maximo / 1000000  # em milh√µes

# ========================================
# VALIDA√á√ÉO DO MODELO
# ========================================
correlacao_simulada <- cor(resultados$produtividade, resultados$preco_final)
cat("Correla√ß√£o obtida entre produtividade e pre√ßo:", 
    round(correlacao_simulada, 3), "\n")
```


```{r}
# ========================================
# ESTAT√çSTICAS DESCRITIVAS
# ========================================
estatisticas_basicas <- data.frame(
  M√©trica = c("Necessidade m√©dia", "Necessidade m√°xima", "Desvio-padr√£o"),
  Valor_Milhoes_R = c(
    round(mean(necessidade_capital), 1),
    round(max(necessidade_capital), 1),
    round(sd(necessidade_capital), 1)
  )
)

# Exibe as estat√≠sticas b√°sicas
estatisticas_basicas
```


```{r}
# ========================================
# PERCENTIS PARA PLANEJAMENTO
# ========================================
percentis <- quantile(necessidade_capital, probs = c(0.50, 0.75, 0.90, 0.95))
tabela_percentis <- data.frame(
  Percentil = c("50%", "75%", "90%", "95%"),
  Cenarios_Cobertos = c("50% dos cen√°rios", "75% dos cen√°rios", 
                        "90% dos cen√°rios", "95% dos cen√°rios"),
  Necessidade_Milhoes_R = round(percentis, 1)
)
print(tabela_percentis)
```

```{r}
# ========================================
# PROBABILIDADES
# ========================================
probabilidades_risco <- data.frame(
  Limite_Milhoes_R = c(1, 2, 3),
  Probabilidade_Exceder_Pct = c(
    round(mean(necessidade_capital > 1) * 100, 1),
    round(mean(necessidade_capital > 2) * 100, 1),
    round(mean(necessidade_capital > 3) * 100, 1)
  )
)

# Exibe as probabilidades 
probabilidades_risco
```


**üí° Interpreta√ß√£o para Administradores:**

- **Planejamento Conservador**: Use o percentil 95% para garantir cobertura 
na maioria dos cen√°rios

- **Gest√£o de Risco**: Monitore as probabilidades de necessidades 
extremas (> R$ 2-3 milh√µes)

- **Estrat√©gias Financeiras**: Combine linha de cr√©dito + reservas 
para otimizar custo de capital





## Decis√µes Estrat√©gicas Baseadas na Simula√ß√£o

```{r}
# Calcula m√©tricas para dimensionamento
necessidade_media <- mean(necessidade_capital)
necessidade_p95 <- quantile(necessidade_capital, 0.95)
necessidade_max <- max(necessidade_capital)

# Resumo executivo para tomada de decis√£o
resumo_executivo <- data.frame(
  Cenario = c("Cen√°rio Base", "Cen√°rio Conservador", "Cen√°rio Stress"),
  Descri√ß√£o = c("Necessidade m√©dia", "Percentil 95%", "Pior caso simulado"),
  Necessidade_Milhoes_R = c(
    round(necessidade_media, 1),
    round(necessidade_p95, 1),
    round(necessidade_max, 1)
  ),
  Uso_Recomendado = c(
    "Or√ßamento inicial",
    "Linha de cr√©dito",
    "Reserva de conting√™ncia"
  )
)

# exibe o resumo 
resumo_executivo
```





## Exerc√≠cio 1

- Simula√ß√£o do √çndice de Liquidez R√°pida

O **√çndice de Liquidez R√°pida (ILR)** mede a capacidade de uma empresa 
pagar suas obriga√ß√µes de curto prazo sem depender da venda de estoques:

$$
\text{ILR} = \frac{\text{Ativo Circulante} - \text{Estoques}}{\text{Passivo Circulante}}
$$

**Cen√°rio**: Voc√™ √© analista financeiro de uma empresa do setor de varejo 
e precisa avaliar o risco de liquidez sob incerteza.

**Informa√ß√µes dos especialistas** (baseadas em dados setoriais):

- **Ativo Circulante**: entre R\$ 800 mil e R\$ 1.200 mil (mais prov√°vel: R\$ 950 mil)
- **Estoques**: entre R\$ 200 mil e R\$ 400 mil (mais prov√°vel: R\$ 280 mil)  
- **Passivo Circulante**: entre R\$ 600 mil e R\$ 900 mil (mais prov√°vel: R\$ 720 mil)

**Suas tarefas**:

1. **Simule 20.000 cen√°rios** do ILR usando Monte Carlo com distribui√ß√µes 
    triangulares
    
2. **Calcule $P(\text{ILR} < 1)$** e interprete o resultado

3. **Compare** o ILR m√©dio simulado com o modelo determin√≠stico 
(valores mais prov√°veis)

4. **Recomende a√ß√µes** se a probabilidade de ILR < 1 for maior que 40%

**C√≥digo estrutura** (complete o c√≥digo):

```{r}
#| eval: false

# fixa a semente para reprodutibilidade
set.seed(2024)

# Define o n√∫mero de simula√ß√µes
n_sim <- 20000

# Complete os par√¢metros (min, max, moda)
ativo_circ <- rtri(n_sim, ___, ___, ___)
estoques   <- rtri(n_sim, ___, ___, ___)
passivo_circ <- rtri(n_sim, ___, ___, ___)

# Calcule o ILR
ilr_sim <- (ativo_circ - estoques) / passivo_circ

# Complete as an√°lises
prob_ilr_baixo <- mean(ilr_sim < 1) * 100
ilr_medio <- mean(ilr_sim)

# Modelo determin√≠stico para compara√ß√£o
ilr_deterministico <- (950 - 280) / 720

# Exiba os resultados
cat("Probabilidade ILR < 1:", round(prob_ilr_baixo, 1), "%\n")
cat("ILR m√©dio simulado:", round(ilr_medio, 2), "\n")
cat("ILR determin√≠stico:", round(ilr_deterministico, 2), "\n")
```

**Perguntas**:

1. Qual a probabilidade de ILR < 1? Como interpreta esse risco?


2. Por que o ILR m√©dio simulado √© pr√≥ximo ao determin√≠stico?


3. Que a√ß√µes recomendaria se P(ILR < 1) > 40%?





# Pacote tidyquant, S√©ries de Pre√ßos e de Retornos de A√ß√µes

## Exemplo 1 - Fun√ß√£o `tq_get()`

Importa√ß√£o de S√©ries de Pre√ßos Di√°rios de 2 A√ß√µes

```{r}
# salva as s√©ries importadas no objeto serie_bivariada
serie_bivariada <- c("AAPL", "META") %>% 
  # obtem os dados de fechamento das a√ß√µes a partir de 01/01/2024
  tq_get(from = "2024-01-01") %>%
  # seleciona as colunas relevantes
  select(symbol, date, close) %>%
  # renomeia as colunas para facilitar a leitura
  rename(
    compania = symbol,
    dia = date,
    preco_fechamento = close
  )
```


```{r}
# Exibe as 6 primeiras linhas da data frame
head(serie_bivariada)
```


```{r}
# Exibe as 6 √∫ltimas linhas da data frame
tail(serie_bivariada)
```



## Prepara√ß√£o de Dados: pivot_wider()

A fun√ß√£o `pivot_wider()` transforma dados do formato longo para o 
formato largo (*wide*),.

**Por que precisamos transformar?**

Para estimar a correla√ß√£o entre as s√©ries de pre√ßos de duas a√ß√µes, precisamos 
que cada s√©rie de pre√ßos seja uma coluna separada, com as datas alinhadas, 
entretanto, a fun√ß√£o tq_get() retorna os dados no formato longo, onde cada 
linha representa um pre√ßo de uma a√ß√£o em uma data espec√≠fica, ou seja, 
as s√©ries de pre√ßos est√£o empilhadas verticalmente.

**Formato Longo** (estrutura retornada pela fun√ß√£o `tq_get()`):

```{r}
dados_longo <- 
tibble(
  empresa = c("PETR4.SA", "PETR4.SA", "ITUB4.SA", "ITUB4.SA"),
  data = as.Date(c("2024-01-02", "2024-01-03", "2024-01-02", "2024-01-03")),
  preco = c(35.50, 36.20, 28.30, 28.75)
)

dados_longo
```

**Formato Largo**:

```{r}
dados_wide <- 
tibble(
  data = as.Date(c("2024-01-02", "2024-01-03")),
  PETR4.SA = c(35.50, 36.20),
  ITUB4.SA = c(28.30, 28.75)
) 

dados_wide
```

**Sintaxe**:

```{r}
dados_wide <- dados_longo %>%
  pivot_wider(
    names_from = empresa,    # vari√°vel que ser√° nomes de colunas
    values_from = preco      # vari√°vel com os valores
  )
  
dados_wide
```



## Exemplo 2 - Fun√ß√£o `tq_get()`

Importa√ß√£o de 3 S√©ries de Pre√ßos Di√°rios de A√ß√µes:

```{r}

serie_precos <- c("PETR4.SA", "MGLU3.SA", "ITUB4.SA") %>% 
  # importa as s√©ries de pre√ßos as a√ß√µes: PETR4, MGLU3 e ITUB4
  tq_get(from = "2024-01-01") %>% 
  # seleciona as vari√°veis relevantes
  select(symbol, date, close) %>%
  # converte o formato longo para o formato largo
  pivot_wider(names_from = symbol, values_from = close) %>% 
  # renomeia as vari√°veis
  rename(dia = date,
         petr4 = PETR4.SA, 
         mglu3 = MGLU3.SA, 
         itub4 = ITUB4.SA) 


# exibe as primeiras linhas
head(serie_precos)
```



## Gr√°ficos: Pre√ßos x Retornos - Petrobr√°s

```{r}
#| echo: false

# extrair a serie de pre√ßos da petrobr√°s do objeto serie_precos
serie_petrobras <- serie_precos %>% 
  select(dia, petr4)

# calcular os retornos simples com mutate 
serie_petrobras <- serie_petrobras %>% 
  mutate(retorno_simples = (petr4 - lag(petr4)) / lag(petr4))

# construir os gr√°ficos de pre√ßos e retornos e organiz√°-los com patchwork
grafico_precos <- serie_petrobras %>% 
  ggplot(aes(x = dia, y = petr4)) +
  geom_line(color = "blue") +
  labs(title = "S√©rie de Pre√ßos da Petrobr√°s",
       x = "Data", y = "Pre√ßo (R$)") +
  theme_minimal()

grafico_retornos <- serie_petrobras %>%
  ggplot(aes(x = dia, y = retorno_simples)) +
  geom_line(color = "red") +
  labs(title = "S√©rie de Retornos Simples da Petrobr√°s",
       x = "Data", y = "Retorno Simples") +
  theme_minimal()

# Organiza os gr√°ficos com patchwork
grafico_precos / grafico_retornos 
```





# Aplica√ß√£o - Valor-em-Risco (VaR) 

## VaR Param√©trico (Normal)

**Exemplo 2**:

Se foram investidos R\$ 100.000,00 em a√ß√µes da XYZ SA, cuja volatilidade 
di√°ria ($\sigma$ = desvio-pad√£o) √© de 2% e o retorno m√©dio de 0%. 
Assumindo que os retornos da a√ß√£o possam ser modelados por uma 
distribui√ß√£o normal. ent√£o, o VaR no n√≠vel de 5% √©:

Em R:

```{r}
#| echo: true
sigma <- 0.02
valor_carteira <- 100000
p <- 0.05

var_95 <- sigma*qnorm(1-p)*valor_carteira
var_95
```

Isto √©, o $VaR_{1, 0.95}$ de 1-dia = R\$ 3.289,71 implica que temos 95% de 
confian√ßa de que a perda da carteira n√£o ser√° superior a R\$ 3.289,80 em um 
dia, ou que temos 5% de chance de que a perda ser√° superior a R\$ 3.289,80.





## VaR Param√©trico Normal em R 

Estimativa do VaR Param√©trico Normal - 1 A√ß√£o:

```{r}
# pipeline para importar os pre√ßos da a√ß√£o da Petrobras
# calcular os retornos e remover valores ausentes
serie_precos_petr4 <- tq_get("PETR4.SA", from = "2024-01-01") %>%
  mutate(ret = log(close / lag(close))) %>%
  drop_na()

# Define par√¢metros
retornos <- serie_precos_petr4$ret
valor_carteira <- 1000
p <- 0.01

# calcula o retorno m√©dio 
ret_medio <- mean(retornos)
ret_medio

# calcula a volatilidade (desvio padr√£o)
volatilidade <- sd(retornos)
volatilidade

# VaR param√©trico
var_param <- -(ret_medio + qnorm(1 - p) * volatilidade)
var_param

# VaR percentual
var_percentual <- var_param * 100
var_percentual

# VaR param√©trico monet√°rio
var_monetario <- var_param * valor_carteira
var_monetario
```




## VaR - M√©todo Hist√≥rico


### M√©todo Hist√≥rico em R

Estimativa do VaR Hist√≥rico - 1 A√ß√£o:

```{r}
# pipeline para importar os pre√ßos da a√ß√£o da Petrobras
# calcular os retornos e remover valores ausentes
precos_petrobras <- "PETR4.SA" %>%
  tq_get(from = "2024-01-01") %>%
  select(date, close) %>% 
  mutate(ret_petrobras = log(close / lag(close))) %>% 
  drop_na()

# Extrai vetor de retornos
ret_petrobras <- precos_petrobras %>% 
  pull(ret_petrobras)

# Par√¢metros
valor_carteira <- 1000
p <- 0.01

# Estima√ß√£o do VaR

# 1. Ordena os retornos crescentemente
ret_petr_ord <- sort(ret_petrobras)

# 2. Encontra o √≠ndice correspondente ao quantil de n√≠vel p
#    Isto √©, o retorno que define a cauda esquerda com p% de probabilidade
#    ceiling() √© usada para garantir que pegamos um valor suficientemente extremo
op <- ceiling(length(ret_petr_ord) * p)  
op

# 3. VaR hist√≥rico monet√°rio: valor correspondente ao retorno mais severo
var_petr_hs <- -ret_petr_ord[op] * valor_carteira
var_petr_hs

# 4. VaR hist√≥rico percentual
var_percentual_petr_hs <- -ret_petr_ord[op] * 100
var_percentual_petr_hs
```

- Usamos `ceiling()` para garantir que selecionamos um retorno 
que est√° entre os **p% piores casos**. Por exemplo, com $T = 252$ e 
$p = 0{,}01$, temos $T \cdot p = 2{,}52$, e o √≠ndice $i = 3$. 

- Assim, usamos o **terceiro pior retorno** da amostra. Isso garante que 
estamos sendo **conservadores**, pois n√£o usamos interpola√ß√£o ‚Äî pegamos 
o pior valor inteiro que garante cobertura de pelo menos $p$ da densidade 
emp√≠rica.




## VaR - M√©todo por Simula√ß√£o de Monte Carlo

C√≥digo - Estimativa do VaR por Simula√ß√£o N√£o-Param√©trica:

```{r}
# pipeline para importar os pre√ßos da a√ß√£o da Petrobras
# calcular os retornos e remover valores ausentes
precos_petrobras <- "PETR4.SA" %>%
  tq_get(from = "2024-01-01") %>%
  select(date, close) %>%
  mutate(ret_petrobras = log(close / lag(close))) %>%
  drop_na()

# Extrai os retornos
ret_petrobras <- precos_petrobras$ret_petrobras

# Define par√¢metros
valor_carteira <- 1000     # valor investido em reais
p <- 0.01                  # n√≠vel de signific√¢ncia (1%)
n <- 1000                  # n√∫mero de simula√ß√µes

# Simula√ß√£o de Monte Carlo (n√£o-param√©trica)
set.seed(123)
ret_simulados <- sample(ret_petrobras, size = n, replace = TRUE)

# Ordena os retornos simulados
ret_simulados_ord <- sort(ret_simulados)

# Encontra o √≠ndice do quantil
# Usamos ceiling() para garantir uma estimativa conservadora (valor mais extremo)
indice_var <- ceiling(n * p)

# Estima o VaR monet√°rio
var_petr_mc <- -ret_simulados_ord[indice_var] * valor_carteira
var_petr_mc

# Estima o VaR percentual
var_percentual_petr_mc <- -ret_simulados_ord[indice_var] * 100
var_percentual_petr_mc
```




## Estima√ß√£o Emp√≠rica do ES

PETR4 ‚Äî Estimativa Emp√≠rica do ES:

```{r}
# 1. Par√¢metros
p <- 0.01
valor_carteira <- 1000

# 2. Ordena os retornos da PETR4
retornos_ordenados <- sort(ret_petrobras)

# 3. √çndice do quantil
k <- ceiling(length(retornos_ordenados) * p)

# 4. VaR e ES emp√≠ricos (percentuais)
var_percentual <- -retornos_ordenados[k] * 100
es_percentual <- -mean(retornos_ordenados[1:k]) * 100

# 5. Valores monet√°rios
var_monetario <- var_percentual / 100 * valor_carteira
es_monetario <- es_percentual / 100 * valor_carteira

# Resultados
var_monetario
es_monetario
```





## Retornos da Carteira em R

Implementa√ß√£o em R:

```{r}
# Importa as s√©ries de pre√ßos das a√ß√µes
serie_precos <- c("PETR4.SA", "MGLU3.SA", "ITUB4.SA") %>% 
  tq_get(from = "2024-01-01") %>%
  select(symbol, date, close) %>%
  pivot_wider(names_from = symbol, values_from = close) %>%
  rename(dia = date,
         petr4 = PETR4.SA,
         mglu3 = MGLU3.SA,
         itub4 = ITUB4.SA)

# Calcula retornos logar√≠tmicos
retornos <- serie_precos %>%
  mutate(
    ret_petr4 = log(petr4 / lag(petr4)),
    ret_mglu3 = log(mglu3 / lag(mglu3)),
    ret_itub4 = log(itub4 / lag(itub4))
  ) %>%
  drop_na()

# Define os pesos
pesos <- c(0.4, 0.3, 0.3)  # exemplo: 40% PETR4, 30% MGLU3, 30% ITUB4

# Calcula o retorno da carteira
retornos <- retornos %>%
  mutate(
    ret_carteira = pesos[1] * ret_petr4 +
                   pesos[2] * ret_mglu3 +
                   pesos[3] * ret_itub4
  )
```


dimens√£o do vertor de retornos da carteira:

```{r}
dim(retornos$ret_carteira)
```


```{r}
# exibie as primeiras linhas
head(retornos$ret_carteira)
```





## VaR Hist√≥rico da Carteira

Estimativa do VaR ‚Äî M√©todo Hist√≥rico

```{r}
# Par√¢metros
p <- 0.01
valor_carteira <- 1000

# Ordena retornos da carteira
ret_ordenado <- sort(retornos$ret_carteira)

# √çndice do quantil
k <- ceiling(length(ret_ordenado) * p)

# VaR percentual e monet√°rio
var_percentual <- -ret_ordenado[k] * 100
var_monetario <- -ret_ordenado[k] * valor_carteira

var_percentual
var_monetario
```



## Estimativa do Expected Shortfall (ES)


Estimativa do ES:

```{r}
# Expected Shortfall (ES)
es_percentual <- -mean(ret_ordenado[1:k]) * 100
es_monetario <- -mean(ret_ordenado[1:k]) * valor_carteira

es_percentual
es_monetario
```

- O **Expected Shortfall** √© a **m√©dia das perdas mais severas**, 
ou seja:

$$
ES = - \frac{1}{k} \sum_{i=1}^{k} r^{(i)}
$$

- O ES sempre **excede (em magnitude)** o VaR ‚Äî √© mais conservador.





## Exerc√≠cio 

Voc√™ √© o analisata respons√°vel por estimar o risco de uma carteira de 
investimentos formada exclusivamente pelas a√ß√µes da empresa **Vale S.A. (VALE3.SA)**, usando dados reais do mercado de capitais.

1. Usando o pacote `tidyquant`, importe os pre√ßos de fechamento 
di√°rios da a√ß√£o **VALE3.SA**, a partir de **01/01/2024**.

2. Calcule os **retornos logar√≠tmicos di√°rios** da a√ß√£o.

3. Suponha que o valor da carteira seja de **R$ 5.000**.

4. Estime o **Value-at-Risk (VaR)** e o **Expected Shortfall (ES)** 
para a carteira, no n√≠vel de probabilidade de **5%**, utilizando 
o **m√©todo hist√≥rico**.

5. Interprete os valores obtidos: o que eles indicam sobre o risco 
da carteira?


